<p-dialog
  [(visible)]="setUpProjectService.assignIndicatorsModal().show"
  (onHide)="setUpProjectService.assignIndicatorsModal.set({ show: false, targetLevel1: undefined, targetLevel2: undefined })"
  header="Add Indicators"
  [modal]="true"
  [closable]="true"
  [style]="{ width: '700px', maxHeight: '85vh' }"
  [draggable]="false">
  @if (setUpProjectService.targetInfo(); as target) {
    <div class="assign-indicators">
      <!-- Target Information -->
      <div class="mb-3 p-3 bg-gray-50 border border-gray-200 rounded-lg">
        <div class="flex items-center space-x-2">
          <i class="pi pi-{{ setUpProjectService.assignIndicatorsModal().targetLevel1 ? 'sitemap' : 'bookmark' }} text-gray-600 text-sm"></i>
          <div>
            <h4 class="font-medium text-gray-900 text-sm">
              Adding indicators to
              {{ setUpProjectService.assignIndicatorsModal().targetLevel1 ? setUpProjectService.level1Name() : setUpProjectService.level2Name() }}
            </h4>
            <p class="text-xs text-gray-600">{{ target.name }}</p>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center space-x-2">
          <h4 class="font-medium text-gray-900 text-sm">Available Indicators</h4>
          <span class="px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded">
            {{ getIndicatorsFiltered().length }}
          </span>
        </div>
        <button
          type="button"
          class="px-3 py-1.5 bg-[#035BA9] hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors flex items-center space-x-1"
          (click)="openCreateIndicatorModal()">
          <i class="pi pi-plus text-xs"></i>
          <span>Create New</span>
        </button>
      </div>

      <!-- Indicators List -->
      @if (getIndicatorsFiltered().length) {
        <div class="space-y-2 max-h-96 overflow-y-auto">
          @for (indicator of getIndicatorsFiltered(); track indicator.id) {
            <div
              class="border rounded-lg p-3 cursor-pointer transition-all duration-200 {{
                indicator.adding ? 'border-gray-200 hover:border-[#035BA9] bg-white hover:bg-blue-50' : 'border-green-600 bg-white hover:bg-gray-50'
              }}"
              (click)="setUpProjectService.assignIndicator(indicator)">
              <!-- Header -->
              <div class="flex justify-between items-start mb-2">
                <div class="flex-1">
                  <div class="flex items-center space-x-2 mb-1">
                    <h5 class="font-medium text-gray-900 text-sm">
                      {{ indicator.name }}
                      @if (indicator.code) {
                        <span class="ml-2 text-xs text-gray-500 font-mono">({{ indicator.code }})</span>
                      }
                    </h5>
                    @if (!indicator.adding) {
                      <span class="px-2 py-0.5 bg-gray-200 text-gray-700 text-xs font-medium rounded"> ASSIGNED </span>
                    }
                  </div>
                  @if (indicator.description) {
                    <p class="text-xs text-gray-600 mb-2 line-clamp-2">{{ indicator.description }}</p>
                  }
                </div>
                <div class="ml-3">
                  <div
                    class="w-6 h-6 rounded-full flex items-center justify-center {{
                      indicator.adding ? 'bg-[#035BA9] hover:bg-blue-700' : 'bg-green-500 hover:bg-green-600'
                    }} transition-colors">
                    <i class="pi {{ indicator.adding ? 'pi-plus' : 'pi-check' }} text-white text-xs"></i>
                  </div>
                </div>
              </div>

              <!-- Details in horizontal layout -->
              <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs mb-2">
                <div class="flex items-center space-x-1">
                  <span class="text-gray-500">Type:</span>
                  <span class="font-medium text-gray-900">{{ indicator.numberType }}</span>
                </div>
                <div class="flex items-center space-x-1">
                  <span class="text-gray-500">Format:</span>
                  <span class="font-medium text-gray-900">{{ indicator.numberFormat }}</span>
                </div>
                @if (indicator.targetUnit) {
                  <div class="flex items-center space-x-1">
                    <span class="text-gray-500">Unit:</span>
                    <span class="font-medium text-gray-900">{{ indicator.targetUnit }}</span>
                  </div>
                }
                <div class="flex items-center space-x-1">
                  <span class="text-gray-500">Years:</span>
                  <span class="font-medium text-gray-900">{{ indicator.years.join(', ') }}</span>
                </div>
              </div>

              <!-- Values -->
              @if (
                (indicator.baseline !== null && indicator.baseline !== undefined && indicator.baseline !== '') ||
                (indicator.targetValue !== null && indicator.targetValue !== undefined && indicator.targetValue !== '')
              ) {
                <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs">
                  @if (indicator.baseline !== null && indicator.baseline !== undefined && indicator.baseline !== '') {
                    <div class="flex items-center space-x-1">
                      <span class="text-gray-500">Baseline:</span>
                      <span class="font-semibold text-gray-900">{{ indicator.baseline }}</span>
                    </div>
                  }
                  @if (indicator.targetValue !== null && indicator.targetValue !== undefined && indicator.targetValue !== '') {
                    <div class="flex items-center space-x-1">
                      <span class="text-gray-500">Target:</span>
                      <span class="font-semibold text-gray-900">{{ indicator.targetValue }}</span>
                    </div>
                  }
                </div>
              }

              <!-- Action Hint -->
              @if (!indicator.adding) {
                <div class="mt-2 p-1.5 bg-gray-100 border border-gray-200 rounded text-xs text-gray-600">
                  <i class="pi pi-info-circle mr-1"></i>
                  Click to remove from this
                  {{ setUpProjectService.assignIndicatorsModal().targetLevel1 ? setUpProjectService.level1Name() : setUpProjectService.level2Name() }}
                </div>
              }
            </div>
          }
        </div>
      } @else {
        <div class="text-center py-6 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
          <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-2">
            <i class="pi pi-info-circle text-gray-500"></i>
          </div>
          <h3 class="font-medium text-gray-700 mb-1">No indicators available</h3>
          <p class="text-xs text-gray-500">Create new indicators using the "Create New" button above.</p>
        </div>
      }
    </div>
  }

  <div class="flex justify-end pt-3 border-t border-gray-200 mt-4">
    <p-button
      label="Close"
      severity="secondary"
      size="small"
      (onClick)="setUpProjectService.assignIndicatorsModal.set({ show: false, targetLevel1: undefined, targetLevel2: undefined })">
    </p-button>
  </div>
</p-dialog>
