<div class="project-setup-container mt-5 max-w-7xl mx-auto px-4 py-4 indicators-progress-view">
  <div class="indicators-section">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-base font-semibold atc-grey-800 flex items-center gap-2">
        <i class="pi pi-chart-line atc-primary-blue-500 text-sm"></i>
        Indicators Progress ({{ indicators().length }})
      </h3>
      @if (indicators().length > 0) {
        <div class="flex items-center gap-2">
          <p-button
            (click)="openIndicatorsInNewTab()"
            icon="pi pi-pencil"
            label="Open edit indicators"
            severity="info"
            [outlined]="true"
            size="small"
            pTooltip="Open edit indicators in new tab"
            tooltipPosition="left"
            class="text-xs">
          </p-button>
          <p-button
            icon="pi pi-chart-bar"
            label="View all indicators chart"
            severity="info"
            [outlined]="true"
            size="small"
            (onClick)="openMainChartModal()"
            pTooltip="View indicators progress chart"
            tooltipPosition="left"
            class="text-xs">
          </p-button>
        </div>
      }
    </div>

    @if (indicators().length > 0) {
      <div class="bg-white rounded-lg shadow-sm overflow-hidden indicators-table-container">
        <p-table
          [resizableColumns]="true"
          [value]="indicators()"
          [responsive]="true"
          styleClass="p-datatable-sm indicators-table"
          [scrollable]="true"
          [tableStyle]="{ 'min-width': '70rem' }"
          size="small">
          <ng-template pTemplate="header">
            <tr>
              <th pSortableColumn="code" class="text-center w-20">
                <div class="flex items-center gap-2">
                  Code
                  <p-sortIcon class="mt-1" field="code" />
                </div>
              </th>
              <th class="text-left w-200">
                <p-columnFilter type="text" field="name" placeholder="Enter key to search" ariaLabel="Filter Country"></p-columnFilter>

                <!-- <span class="atc-grey-700">Statement</span> -->
              </th>
              <th class="text-center w-24">
                <div class="flex items-center gap-2">
                  Base
                  <p-sortIcon class="mt-1" field="base_line" />
                </div>
              </th>
              <th class="text-center w-24">
                <div class="flex items-center gap-2">
                  Target
                  <p-sortIcon class="mt-1" field="target_value" />
                </div>
              </th>
              <th class="text-center w-24">
                <div class="flex items-center gap-2">
                  Current
                  <p-sortIcon class="mt-1" field="total_contributions" />
                </div>
              </th>
              <th class="text-center w-24">
                <div class="flex items-center gap-2">
                  Type
                  <p-sortIcon class="mt-1" field="number_type" />
                </div>
              </th>
              <th class="text-center w-32">
                <div class="flex items-center gap-2">
                  Progress
                  <p-sortIcon class="mt-1" field="percentageProgress" />
                </div>
              </th>
              <th class="text-center w-32">
                <span>Contributors</span>
              </th>
              <th class="text-center w-24">
                <span>Actions</span>
              </th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-indicator let-rowIndex="rowIndex">
            <tr class="hover:abc-grey-100 transition-colors">
              <td class="text-center">
                @if (indicator.code) {
                  <span class="abc-primary-blue-500 atc-white-1 px-2 py-1 rounded text-xs font-mono font-medium">{{ indicator.code }}</span>
                } @else {
                  <span class="text-xs atc-grey-400">-</span>
                }
              </td>
              <td class="text-left">
                <div class="py-2">
                  <h4 class="text-sm atc-grey-800 leading-tight font-medium">{{ indicator.name }}</h4>
                </div>
              </td>
              <td class="text-center">
                <span class="text-sm font-semibold atc-grey-700">{{ indicator.base_line || 0 }}</span>
              </td>
              <td class="text-center">
                @if (indicator.target_value) {
                  <span class="text-sm font-semibold atc-primary-blue-500">{{ indicator.target_value }}</span>
                } @else {
                  <span class="text-xs atc-grey-400">-</span>
                }
              </td>
              <td class="text-center">
                <span class="text-sm font-semibold atc-green-600">{{
                  indicator.number_type === 'sum' ? indicator.total_contributions : indicator.total_average_contributions
                }}</span>
              </td>
              <td class="text-center">
                <span class="abc-grey-100 atc-grey-800 px-2 py-1 rounded text-xs font-medium capitalize">{{ indicator.number_type }}</span>
              </td>
              <td class="text-center">
                @if (indicator.number_type !== 'average') {
                  <div class="flex flex-col items-center gap-1">
                    <p-progressBar
                      [value]="indicator.percentageProgress"
                      [showValue]="false"
                      [style]="{ height: '8px', width: '100px' }"
                      styleClass="custom-progress-primary">
                    </p-progressBar>
                    <span class="text-xs font-medium atc-primary-blue-500"> {{ indicator.percentageProgress.toFixed(1) }}% </span>
                  </div>
                } @else {
                  <div class="flex items-center justify-center h-8">
                    <span class="text-xs atc-grey-500 font-medium">N/A</span>
                  </div>
                }
              </td>
              <td class="text-center">
                @if (indicator.contributions.length > 0) {
                  <app-contributors-overlay
                    [contributions]="indicator.contributions"
                    [contributorsCount]="indicator.contributions.length"
                    [indicatorType]="indicator.number_type"
                    [currentValue]="indicator.number_type === 'sum' ? indicator.total_contributions : indicator.total_average_contributions">
                  </app-contributors-overlay>
                } @else {
                  <span class="text-xs atc-grey-400">No contributors</span>
                }
              </td>
              <td class="text-center">
                <p-button
                  icon="pi pi-chart-bar"
                  label="View Chart"
                  severity="secondary"
                  [text]="true"
                  size="small"
                  (onClick)="openDetailModal(indicator)"
                  pTooltip="View detailed chart"
                  tooltipPosition="top"
                  class="text-xs">
                </p-button>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    } @else {
      <div class="text-center py-8 bg-gray-50 rounded-lg">
        <i class="pi pi-chart-line text-3xl mb-3 block text-gray-300"></i>
        <h4 class="text-base font-semibold text-gray-700 mb-2">No indicators progress data</h4>
        <p class="text-sm text-gray-500 mb-4">Indicators progress will appear here once contributions are made.</p>
      </div>
    }
  </div>
</div>

<!-- Detail Modal -->
<app-indicator-detail-modal [visible]="showDetailModal" [indicator]="selectedIndicator" (visibleChange)="showDetailModal = $event">
</app-indicator-detail-modal>

<!-- Main Chart Modal -->
<app-main-chart-modal [visible]="showMainChartModal" [indicators]="indicators()" (visibleChange)="showMainChartModal = $event">
</app-main-chart-modal>
