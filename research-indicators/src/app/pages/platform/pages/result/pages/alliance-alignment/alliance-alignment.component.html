<div class="app-page-wrapper">
  <app-form-header />
  <div class="flex flex-col gap-5">
    <div class="content-section">
      <div class="flex flex-col bg-[#fcfcfc] rounded-[10px] p-[30px] mb-6">
        <div class="font-['Space_Grotesk'] text-[14px] font-medium text-[#8d9299] uppercase mb-[30px] mt-0">ALLIANCE ALIGNMENT</div>
        <div class="flex flex-col gap-[25px]">
          <div>
            <app-multiselect
              label="Contributing projects"
              [signal]="body"
              textSpan="Select the required primary project for this result. Note that only one project can be selected."
              optionLabel="select_label"
              optionValue="contract_id"
              signalOptionValue="contracts"
              [disabled]="!submission.isEditableStatus()"
              [removeCondition]="canRemove"
              [isRequired]="true"
              [scrollHeight]="'290px'"
              [itemHeight]="70"
              serviceName="contracts"
              [serviceParams]="contractServiceParams()"
              placeholder="Select the contributing projects">
              <ng-template #item let-item>
                <div class="flex flex-col gap-2 h-[54px] text-[14px]" pTooltip="{{ item?.description }}">
                  <p class="text-[#4C5158] font-[400]">
                    <b>{{ item?.agreement_id }} -</b>
                    {{ getShortDescription(item?.description) }}
                  </p>

                  <p class="space-x-3 text-[11px] text-[#777C83]">
                    <button
                      class="uppercase max-w-24 text-[10px] font-semibold px-2 py-1 rounded-lg"
                      [class]="getContractStatusClasses(item?.contract_status)">
                      {{ item?.contract_status }}
                    </button>
                    Principal investigator <i class="pi pi-arrow-right !text-[7px] text-[#777C83] pl-1"></i>
                    <span class="text-[#345B8F]">{{ item?.project_lead_description }}</span>
                    <span class="text-[#B9C0C5]">|</span>
                    Start date <i class="pi pi-arrow-right !text-[7px] text-[#777C83] pl-1"></i>
                    <span class="text-[#345B8F]">{{ item?.start_date | date: 'dd/MM/yyyy' }}</span>
                    @if (item?.end_date) {
                      <span class="text-[#B9C0C5]">|</span>
                      End date <i class="pi pi-arrow-right !text-[7px] text-[#777C83] pl-1"></i>
                      <span class="text-[#345B8F]">{{ item?.end_date | date: 'dd/MM/yyyy' }}</span>
                    }
                  </p>
                </div>
              </ng-template>

              <ng-template #selectedItems let-value>
                @if (value?.length > 0) {
                  <div class="flex items-center gap-2">
                    <span> {{ value?.length }} project{{ value?.length === 1 ? '' : 's' }} selected </span>
                  </div>
                }
              </ng-template>
              <ng-template #rows let-contract>
                <div class="flex-col flex w-full">
                  <div class="text-[15px] text-[#4C5158] font-[600]">{{ contract.agreement_id }} - {{ contract.description }}</div>

                  <div class="flex justify-between pt-2 xl:pt-0">
                    <div class="flex gap-x-5 justify-between">
                      <div class="flex items-center">
                        <span class="font-normal text-[13px] text-[#777c83] font-['Space_Grotesk'] leading-4">Principal investigator</span>
                        <i class="pi pi-arrow-right !text-[8px] px-2 !text-[#8D9299]"></i>
                        <span class="text-[13px] uppercase leading-[18px] text-[#345b8f] font-['Space_Grotesk']">{{
                          contract.project_lead_description
                        }}</span>
                      </div>

                      <div class="flex items-center">
                        <span class="text-[13px] text-[#777c83] font-['Space_Grotesk'] leading-4">Start date</span>
                        <i class="pi pi-arrow-right !text-[8px] px-2 !text-[#8D9299]"></i>
                        <span class="text-[13px] leading-[18px] text-[#345b8f] font-['Space_Grotesk']">{{
                          contract.start_date | date: 'dd/MM/yyyy'
                        }}</span>
                      </div>

                      <div class="flex items-center">
                        <span class="text-[13px] text-[#777c83] font-['Space_Grotesk'] leading-4">End date</span>
                        <i class="pi pi-arrow-right !text-[8px] px-2 !text-[#8D9299]"></i>
                        <span class="text-[13px] leading-[18px] text-[#345b8f] font-['Space_Grotesk']">{{
                          contract.endDateGlobal | date: 'dd/MM/yyyy'
                        }}</span>
                      </div>
                    </div>
                    <div class="pl-4">
                      <button
                        [disabled]="!submission.isEditableStatus()"
                        class="px-3 py-[5px] disabled:cursor-not-allowed rounded-full text-[14px] whitespace-nowrap flex items-center cursor-pointer transition-all duration-300 group border border-[var(--ac-primary-blue-300)]"
                        [class]="
                          contract.is_primary
                            ? 'bg-[var(--ac-primary-blue-300)] text-white disabled:bg-[#8D9299] disabled:border-[#8D9299]'
                            : 'disabled:bg-[#E8EBED] disabled:!text-[#8D9299] disabled:border-[#8D9299] bg-transparent text-[var(--ac-primary-blue-300)]'
                        "
                        (click)="markAsPrimary(contract, 'contract')">
                        @if (contract.is_primary) {
                          <i class="pi pi-star-fill pr-2 !text-[12px] !text-white"></i>
                        }
                        {{ contract.is_primary ? 'Primary' : 'Select as Primary' }}
                      </button>
                    </div>
                  </div>

                  <div class="flex items-center pt-1 xl:pt-0.5 text-[13px] leading-[18px] text-[#4C5158] gap-x-1 font-['Barlow'] font-[600]">
                    @if (contract.levers?.full_name === 'Not available' || !contract.levers) {
                      Lever - <span class="text-[#4C5158] font-['Barlow'] font-normal">{{ contract.levers?.full_name || 'Not available' }}</span>
                    } @else {
                      <img [src]="contract.levers?.lever_url" alt="Lever" class="w-[22px] h-[22px] mr-1" />
                      @if (contract.levers?.full_name?.includes(':')) {
                        <span class="text-[13px] leading-[18px] text-[#77c83] font-['Barlow'] font-normal">{{ contract.levers?.full_name }}</span>
                      } @else {
                        {{ contract.levers?.short_name || contract.levers?.full_name || '' }}
                      }
                    }
                  </div>
                </div>
              </ng-template>
            </app-multiselect>
          </div>

          <div class="flex flex-col pt-2">
            <app-multiselect
              label="Primary Levers"
              [disabled]="!submission.isEditableStatus()"
              [signal]="body"
              optionValue="lever_id"
              signalOptionValue="primary_levers"
              [isRequired]="true"
              [columnsOnXl]="true"
              [textSpan]="'Levers selected'"
              [filterBy]="'short_name,other_names'"
              scrollHeight="260px"
              serviceName="levers"
              [optionsDisabled]="primaryOptionsDisabled"
              placeholder="Select the levers">
              <ng-template #selectedItems let-value>
                @if (value?.length > 0) {
                  <div class="flex items-center gap-2">
                    <span>{{ value?.length }} Lever{{ value?.length === 1 ? '' : 's' }} selected </span>
                  </div>
                }
              </ng-template>
              <ng-template #item let-item>
                <div class="flex items-center gap-2 text-[##4C5158]">
                  <span class="font-[600]">
                    {{ item?.short_name }}: <span class="font-['Barlow'] font-normal">{{ item?.other_names }}</span></span
                  >
                </div>
              </ng-template>
              <ng-template #rows let-lever>
                <div class="flex-col flex w-full">
                  <div class="flex items-center pt-1 xl:pt-0.5 text-[13px] leading-[18px] text-[#4C5158] gap-x-1 font-['Barlow'] font-[600]">
                    <img [src]="lever.icon" [alt]="lever.short_name" class="w-[35px] h-[35px] mr-2 rounded-[3px]" />
                    <span class="text-[15px] text-[#4C5158] font-[600]">
                      {{ lever?.short_name }}: <span class="font-['Barlow'] font-normal">{{ lever?.other_names }}</span></span
                    >
                  </div>
                </div>
              </ng-template>
            </app-multiselect>
          </div>

          <div class="flex flex-col pt-3">
            <app-multiselect
              label="Other Contributing Levers"
              [disabled]="!submission.isEditableStatus()"
              [signal]="body"
              optionValue="lever_id"
              signalOptionValue="contributor_levers"
              [columnsOnXl]="true"
              scrollHeight="260px"
              serviceName="levers"
              [filterBy]="'short_name,other_names'"
              [textSpan]="'Levers selected'"
              [optionsDisabled]="optionsDisabled"
              placeholder="Select the levers">
              <ng-template #selectedItems let-value>
                @if (value?.length > 0) {
                  <div class="flex items-center gap-2">
                    <span>{{ value?.length }} Lever{{ value?.length === 1 ? '' : 's' }} selected </span>
                  </div>
                }
              </ng-template>
              <ng-template #item let-item>
                <div class="flex items-center gap-2">
                  <span class="font-[600] text-[##4C5158]">
                    {{ item?.short_name }}: <span class="font-['Barlow'] font-normal">{{ item?.other_names }}</span></span
                  >
                </div>
              </ng-template>
              <ng-template #rows let-lever>
                <div class="flex-col flex w-full">
                  <div class="flex items-center pt-1 xl:pt-0.5 text-[13px] leading-[18px] text-[#4C5158] gap-x-1 font-['Barlow'] font-[600]">
                    <img [src]="lever.icon" [alt]="lever.short_name" class="w-[35px] h-[35px] mr-2 rounded-[3px]" />
                    <span class="text-[15px] text-[#4C5158] font-[600]">
                      {{ lever?.short_name }}: <span class="font-['Barlow'] font-normal">{{ lever?.other_names }}</span></span
                    >
                  </div>
                </div>
              </ng-template>
            </app-multiselect>
          </div>

          @if (body().primary_levers.length > 0 && cache.currentMetadata().indicator_id === 5) {
          <div class="flex flex-col pt-3">
            <span class="text-[#1689CA] text-[16px] leading-[17px] pb-3 font-semibold">Primary lever strategic outcomes</span>
            
            @for (lever of body().primary_levers; track lever.lever_id) {
              <div class="flex flex-col p-4 pr-0">
                <div class="flex items-center">
                  <img [src]="lever.icon" [alt]="lever.short_name" class="w-[35px] h-[35px] mr-3 rounded-[3px]" />
                  <span class="text-[15.5px] text-[#153C71] font-[600]">
                    {{ lever?.short_name }}{{ lever?.other_names ? ': ' + lever?.other_names : '' }} <span class="text-red-500">*</span>
                  </span>
                </div>
                <app-multiselect
                  [isRequired]="true"
                  [signal]="getLeverSignal(lever)"
                  signalOptionValue="result_lever_strategic_outcomes"
                  optionValue="id"
                  optionLabel="strategic_outcome"
                  serviceName="leverStrategicOutcomes"
                  [enableVirtualScroll]="false"
                  [scrollHeight]="'200px'"
                  [textSpan]="'Strategic outcome selected'"
                  [serviceParams]="lever.lever_id"
                  placeholder="Select the option">
                  <ng-template #selectedItems let-value>
                    @if (value?.length > 0) {
                      <div class="flex items-center gap-2">
                        <span>{{ value?.length }} Strategic outcome{{ value?.length === 1 ? '' : 's' }} selected </span>
                      </div>
                    }
                  </ng-template>

                  <ng-template #item let-item>
                    <div class="flex items-center gap-2 text-[#4C5158] flex items-center block whitespace-normal break-words gap-2 leading-5">
                      @if (item?.strategic_outcome?.includes(':')) {
                        <span>
                          <b>{{ item?.strategic_outcome?.split(':')[0] }}:</b>
                          {{ item?.strategic_outcome?.split(':')[1]?.trim() }}
                        </span>
                      } @else {
                        <span>{{ item?.strategic_outcome }}</span>
                      }
                    </div>
                  </ng-template>


              <ng-template #rows let-strategicOutcome>
                <div class="flex-col flex w-full">
                  <div class="flex items-center gap-2 text-[#4C5158] flex items-center block whitespace-normal break-words gap-2 leading-5">
                    @if (strategicOutcome?.strategic_outcome?.includes(':')) {
                      <span>
                        <b>{{ strategicOutcome?.strategic_outcome?.split(':')[0] }}:</b>
                        {{ strategicOutcome?.strategic_outcome?.split(':')[1]?.trim() }}
                      </span>
                    } @else {
                      <span>{{ strategicOutcome?.strategic_outcome }}</span>
                    }
                  </div>
                </div>
              </ng-template>
                </app-multiselect>
              </div>
            }
          </div>
          }
          <div class="flex flex-col {{ (body().primary_levers.length > 0 && cache.currentMetadata().indicator_id === 5) ? '-mt-2' : 'pt-3' }}">
            <app-multiselect
              label="Contribution to SDG targets"
              [signal]="body"
              helperText="Indicate the SDGs to which the result is linked."
              optionLabel="select_label"
              optionValue="sdg_id"
              signalOptionValue="result_sdgs"
              [disabled]="!submission.isEditableStatus()"
              [removeCondition]="canRemove"
              [isRequired]="true"
              [columnsOnXl]="true"
              serviceName="sdgs"
              placeholder="Select the SDG targets">
              <ng-template #selectedItems let-value>
                @if (value?.length > 0) {
                  <div class="flex items-center gap-2">
                    <span>{{ value?.length }} SDG{{ value?.length === 1 ? '' : 's' }} selected </span>
                  </div>
                }
              </ng-template>
              <ng-template #rows let-sdg>
                <div class="flex-col flex w-full">
                  <div class="flex items-center pt-1 xl:pt-0.5 text-[13px] leading-[18px] text-[#4C5158] gap-x-1 font-['Barlow'] font-[600]">
                    @if (sdg.icon) {
                      <img [src]="sdg.icon" [alt]="sdg.short_name" class="w-[35px] h-[35px] mr-2 rounded-[3px]" />
                    }
                    @if (sdg.description) {
                      <span class="text-[15px] text-[#4C5158] font-[600]">
                        SDG {{ sdg.short_name?.split(':')[0] }} - <span class="font-normal">{{ sdg.short_name?.split(':')[1]?.trim() }} </span></span
                      >
                    }
                  </div>
                </div>
              </ng-template>
            </app-multiselect>
          </div>
        </div>
      </div>
    </div>
  </div>

  <app-navigation-buttons (back)="saveData('back')" (next)="saveData('next')" (save)="saveData()" />
</div>
