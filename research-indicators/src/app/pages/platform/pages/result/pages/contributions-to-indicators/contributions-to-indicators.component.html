<div class="app-page-wrapper">
  <app-form-header />
  <div class="flex flex-col bg-[#fcfcfc] rounded-[10px] p-[30px] mb-6">
    <div class="font-['Space_Grotesk'] text-[14px] font-medium text-[#8d9299] uppercase mb-[30px] mt-0">CONTRIBUTIONS TO INDICATORS</div>

    <div class="text-[12px] text-[#8D9299] mb-6">
      This section needs to be completed because this result is mapped to one or more projects with configured indicators.
    </div>

    <p-tabs [value]="currentProject()?.agreement_id ?? ''" scrollable class="mb-6">
      <p-tablist>
        @for (tab of projects(); track tab.agreement_id) {
          <p-tab
            pInputText
            [pTooltip]="tab.description"
            tooltipPosition="right"
            [value]="tab.agreement_id"
            (click)="onProjectChange(tab)"
            (keydown.enter)="onProjectChange(tab)"
            class="mx-1">
            {{ tab.agreement_id }}
          </p-tab>
        }
      </p-tablist>
    </p-tabs>

    <div class="flex flex-col gap-4 mb-4">
      <label for="indicators-multiselect" class="block text-sm font-medium text-gray-700">Select indicators</label>
      <!-- <p-multiSelect
        id="indicators-multiselect"
        placeholder="Select indicators"
        [options]="currentIndicators()"
        [(ngModel)]="selectedProjects"
        optionLabel="name"
        optionValue="id"
        [filter]="true"
        [filterBy]="'name'"
        class="w-full" /> -->
      @if (!loading()) {
        <app-multiselect
          label="Contributing indicators"
          [signal]="body"
          textSpan="Select the required contributing indicators for this result."
          optionLabel="name"
          placeholder="Select contributing indicators"
          optionValue="id"
          signalOptionValue="selectedIndicators"
          [isRequired]="false"
          [scrollHeight]="'290px'"
          [filterBy]="'name,code,description,targetUnit,type'"
          [itemHeight]="120"
          [disabledSelectedScroll]="true"
          serviceName="getProjectIndicatorsHierarchy">
          <ng-template #item let-item>
            <div class="p-3 hover:bg-gray-50 border-b border-gray-100 transition-colors duration-200 space-y-2">
              <!-- Title section - full width -->
              <div class="flex items-center gap-3">
                <span class="bg-blue-50 text-blue-700 px-2 py-1 rounded-md font-medium text-xs shrink-0">{{ item.code }}</span>
                <h3 class="font-semibold text-gray-900 text-sm leading-tight flex-1">{{ item.name }}</h3>
              </div>

              <!-- Description -->
              @if (item.description) {
                <p class="text-xs text-gray-600 leading-relaxed line-clamp-2">{{ item.description }}</p>
              }

              <!-- Hierarchy breadcrumb -->
              <div class="flex items-center gap-1 text-xs">
                <span class="text-gray-500 font-medium shrink-0">Path:</span>
                @if (item.group_item?.parent_item?.name) {
                  <span
                    [pTooltip]="item.group_item.parent_item.name"
                    tooltipPosition="right"
                    class="bg-indigo-50 text-indigo-700 px-1.5 py-0.5 rounded text-[10px] shrink-0"
                    >{{ item.group_item.parent_item.code }}</span
                  >
                  <i class="pi pi-angle-right text-gray-400 text-[8px]"></i>
                }
                @if (item.group_item?.name) {
                  <span
                    [pTooltip]="item.group_item.name"
                    tooltipPosition="right"
                    class="bg-green-50 text-green-700 px-1.5 py-0.5 rounded text-[10px] shrink-0"
                    >{{ item.group_item.code }}</span
                  >
                  <i class="pi pi-angle-right text-gray-400 text-[8px]"></i>
                }
                <span
                  [pTooltip]="item.name"
                  tooltipPosition="right"
                  class="bg-orange-50 text-orange-700 px-1.5 py-0.5 rounded text-[10px] truncate"
                  >{{ item.code }}</span
                >
              </div>

              <!-- Metadata chips - horizontal scroll -->
              <div class="overflow-x-auto">
                <div class="flex gap-1 text-xs pb-1">
                  <span class="inline-flex items-center px-2 py-1 rounded-md bg-gray-50 text-gray-600 border border-gray-200 whitespace-nowrap">
                    <strong>Unit:</strong>&nbsp;{{ item.targetUnit || 'N/A' }}
                  </span>
                  <span class="inline-flex items-center px-2 py-1 rounded-md bg-gray-50 text-gray-600 border border-gray-200 whitespace-nowrap">
                    <strong>Target:</strong>&nbsp;{{ item.targetValue || 'N/A' }}
                  </span>
                  @if (item.baseLine) {
                    <span class="inline-flex items-center px-2 py-1 rounded-md bg-gray-50 text-gray-600 border border-gray-200 whitespace-nowrap">
                      <strong>Baseline:</strong>&nbsp;{{ item.baseLine }}
                    </span>
                  }
                  @if (item.numberType) {
                    <span
                      class="inline-flex items-center px-2 py-1 rounded-md bg-gray-50 text-gray-600 border border-gray-200 whitespace-nowrap capitalize">
                      <strong>Type:</strong>&nbsp;{{ item.numberType }}
                    </span>
                  }
                  @if (item.numberFormat) {
                    <span class="inline-flex items-center px-2 py-1 rounded-md bg-gray-50 text-gray-600 border border-gray-200 whitespace-nowrap">
                      <strong>Format:</strong>&nbsp;{{ item.numberFormat }}
                    </span>
                  }
                  @if (item.year && item.year.length > 0) {
                    <span class="inline-flex items-center px-2 py-1 rounded-md bg-gray-50 text-gray-600 border border-gray-200 whitespace-nowrap">
                      <strong>Years:</strong>&nbsp;{{ item.year.join(', ') }}
                    </span>
                  }
                  @if (item.type) {
                    <span
                      class="inline-flex items-center px-2 py-1 rounded-md bg-gray-50 text-gray-600 border border-gray-200 whitespace-nowrap capitalize">
                      <strong>Category:</strong>&nbsp;{{ item.type }}
                    </span>
                  }
                </div>
              </div>
            </div>
          </ng-template>

          <ng-template #selectedItems let-value>
            <div>Selected Indicators: {{ this.body().selectedIndicators.length }}</div>
          </ng-template>
          <ng-template #rows let-indicator>
            <div class="w-full bg-white border border-gray-200 rounded-lg p-4 shadow-sm mb-4 space-y-3">
              <!-- Title section - cÃ³digo a la izquierda -->
              <div class="flex items-center gap-3">
                <span class="bg-blue-50 text-blue-700 px-2 py-1 rounded-md font-medium text-xs shrink-0">{{ indicator.code }}</span>
                <h4 class="font-semibold text-gray-900 text-sm leading-tight flex-1">{{ indicator.name }}</h4>
              </div>

              <!-- Description -->
              @if (indicator.description) {
                <p class="text-xs text-gray-600 leading-relaxed line-clamp-2">{{ indicator.description }}</p>
              }

              <!-- Hierarchy breadcrumb -->
              <div class="flex items-center gap-1 text-xs">
                <span class="text-gray-500 font-medium shrink-0">Path:</span>
                @if (indicator.group_item?.parent_item?.name) {
                  <span
                    [pTooltip]="indicator.group_item.parent_item.name"
                    tooltipPosition="right"
                    class="bg-indigo-50 text-indigo-700 px-1.5 py-0.5 rounded text-[10px] shrink-0"
                    >{{ indicator.group_item.parent_item.code }}</span
                  >
                  <i class="pi pi-angle-right text-gray-400 text-[8px]"></i>
                }
                @if (indicator.group_item?.name) {
                  <span
                    [pTooltip]="indicator.group_item.name"
                    tooltipPosition="right"
                    class="bg-green-50 text-green-700 px-1.5 py-0.5 rounded text-[10px] shrink-0"
                    >{{ indicator.group_item.code }}</span
                  >
                  <i class="pi pi-angle-right text-gray-400 text-[8px]"></i>
                }
                <span
                  [pTooltip]="indicator.name"
                  tooltipPosition="right"
                  class="bg-orange-50 text-orange-700 px-1.5 py-0.5 rounded text-[10px] truncate"
                  >{{ indicator.code }}</span
                >
              </div>

              <!-- Metadata chips - horizontal scroll -->
              <div class="overflow-x-auto">
                <div class="flex gap-1 text-xs pb-1">
                  <span class="inline-flex items-center px-2 py-1 rounded-md bg-gray-50 text-gray-600 border border-gray-200 whitespace-nowrap">
                    <strong>Unit:</strong>&nbsp;{{ indicator.targetUnit || 'N/A' }}
                  </span>
                  <span class="inline-flex items-center px-2 py-1 rounded-md bg-gray-50 text-gray-600 border border-gray-200 whitespace-nowrap">
                    <strong>Target:</strong>&nbsp;{{ indicator.targetValue || 'N/A' }}
                  </span>
                  @if (indicator.baseLine) {
                    <span class="inline-flex items-center px-2 py-1 rounded-md bg-gray-50 text-gray-600 border border-gray-200 whitespace-nowrap">
                      <strong>Baseline:</strong>&nbsp;{{ indicator.baseLine }}
                    </span>
                  }
                  @if (indicator.numberType) {
                    <span
                      class="inline-flex items-center px-2 py-1 rounded-md bg-gray-50 text-gray-600 border border-gray-200 whitespace-nowrap capitalize">
                      <strong>Type:</strong>&nbsp;{{ indicator.numberType }}
                    </span>
                  }
                  @if (indicator.numberFormat) {
                    <span class="inline-flex items-center px-2 py-1 rounded-md bg-gray-50 text-gray-600 border border-gray-200 whitespace-nowrap">
                      <strong>Format:</strong>&nbsp;{{ indicator.numberFormat }}
                    </span>
                  }
                  @if (indicator.year && indicator.year.length > 0) {
                    <span class="inline-flex items-center px-2 py-1 rounded-md bg-gray-50 text-gray-600 border border-gray-200 whitespace-nowrap">
                      <strong>Years:</strong>&nbsp;{{ indicator.year.join(', ') }}
                    </span>
                  }
                  @if (indicator.type) {
                    <span
                      class="inline-flex items-center px-2 py-1 rounded-md bg-gray-50 text-gray-600 border border-gray-200 whitespace-nowrap capitalize">
                      <strong>Category:</strong>&nbsp;{{ indicator.type }}
                    </span>
                  }
                </div>
              </div>

              <!-- Contribution input section -->
              <div class="bg-gray-50 p-4 rounded-lg border-t border-gray-200">
                <div class="mb-4">
                  <p class="text-sm text-gray-600 mb-3">
                    If this reported result does not contribute directly to the indicator, please enter the number 0. Otherwise, indicate the
                    contribution of this result to the target.
                  </p>

                  <div class="flex items-center gap-3 mb-4">
                    <input
                      type="checkbox"
                      [id]="'no-contribution-' + indicator.id"
                      [checked]="indicator.contribution_value === null"
                      (change)="toggleContribution(indicator, $event)"
                      class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500" />
                    <label [for]="'no-contribution-' + indicator.id" class="text-sm font-medium text-gray-700">
                      This result does not contribute directly to this indicator
                    </label>
                  </div>
                </div>

                <div class="flex items-start gap-4">
                  @if (indicator.contribution_value !== null) {
                    <div class="flex-1">
                      <label for="contribution-value-{{ indicator.id }}" class="block text-sm font-medium text-gray-700 mb-2">
                        {{ indicator.targetUnit || 'units' }}
                        <span class="text-gray-500 font-normal">(Contribution Value)</span>
                      </label>
                      <p-inputNumber
                        [style]="{ width: '100%', maxWidth: '300px' }"
                        [id]="'contribution-value-' + indicator.id"
                        [(ngModel)]="indicator.contribution_value"
                        [minFractionDigits]="indicator.numberFormat === 'decimal' ? 1 : 0"
                        [maxFractionDigits]="indicator.numberFormat === 'decimal' ? 4 : 0"
                        [placeholder]="'Enter value in ' + (indicator.targetUnit || 'units')"
                        class="w-full">
                      </p-inputNumber>
                    </div>
                  }
                  <div class="flex gap-2" [class.mt-8]="indicator.contribution_value !== 0">
                    @if (indicator.targetValue) {
                      <div class="bg-green-50 border border-green-200 px-3 py-2 rounded-md flex items-center gap-2">
                        <span class="text-xs text-green-600 font-medium">Target:</span>
                        <span class="text-sm font-semibold text-green-700">{{ indicator.targetValue }}</span>
                      </div>
                    }
                    @if (indicator.baseLine) {
                      <div class="bg-blue-50 border border-blue-200 px-3 py-2 rounded-md flex items-center gap-2">
                        <span class="text-xs text-blue-600 font-medium">Baseline:</span>
                        <span class="text-sm font-semibold text-blue-700">{{ indicator.baseLine }}</span>
                      </div>
                    }
                  </div>
                </div>
              </div>
            </div>
          </ng-template>
        </app-multiselect>
      }
    </div>
  </div>

  <app-navigation-buttons (back)="saveData('back')" (next)="saveData('next')" (save)="saveData()" />
</div>
