@if (documentAnalyzed() && selectedFile) {
  <div class="document-analyzed-container">
    <i class="pi pi-file upload-icon" style="font-size: 32px; margin: 0"></i>
    <p class="upload-text" style="font-weight: 500; margin: 0">{{ selectedFile.name }}</p>
  </div>
}

<section
  class="mx-auto w-full container flex flex-col gap-6 justify-start rounded-b-[27px] px-16"
  [ngStyle]="{ 'margin-top': documentAnalyzed() ? '0' : '40px' }"
  [ngClass]="{ 'analyzing-container': analyzingDocument() }">
  @if (!analyzingDocument() && !documentAnalyzed()) {
    <div class="gap-[20px] grid grid-cols-[120px_1fr]">
      <img src="/images/upload-ai.svg" alt="upload-ai" style="width: 100%" />

      <div class="title-group">
        <p class="subtitle">AI ASSISTANCE</p>
        <h1 class="title">UPLOAD YOUR DOCUMENTS</h1>
        <p class="description">
          Upload your research documents, and let the AI-powered system analyze them to generate actionable insights and populate key fields
          automatically.
        </p>
      </div>
    </div>
    <div class="flex flex-col xl:px-44 px-12">
      <h2 class="mb-[6px] font-[600] text-[17px] text-[#153C71]" style="margin-top: 0">Primary Project <span class="text-red-500">*</span></h2>

      <p-select
        [options]="getContractsService.list()"
        [(ngModel)]="body().contract_id"
        optionLabel="select_label"
        optionValue="agreement_id"
        placeholder="Search by project code, project name or principal investigator"
        [virtualScroll]="true"
        [lazy]="true"
        [virtualScrollItemSize]="10"
        [style]="isInvalid() ? { width: '100%', border: '2px solid #E69F00' } : { width: '100%' }"
        [filter]="true"
        (ngModelChange)="body.set({ contract_id: $event })"
        [filterBy]="'select_label,project_lead_description'"
        class="!text-base">
        <ng-template let-item pTemplate="item">
          <div class="primary-item">
            <p>
              <b>{{ item?.agreement_id }} -</b> {{ item?.description }}
            </p>
            <p class="primary-item-investigator space-x-3">
              Principal investigator &rarr;
              <span class="primary-item-investigator-name">{{ item?.project_lead_description }}</span>
              <span class="text-[#B9C0C5]">|</span>
              Start date &rarr;
              <span class="primary-item-investigator-name">{{ item?.start_date | date: 'dd MMMM yyyy' }}</span>
              <span class="text-[#B9C0C5]">|</span>
              End date &rarr;
              <span class="primary-item-investigator-name">{{ item?.end_date | date: 'dd MMMM yyyy' }}</span>
            </p>
          </div>
          <div class="px-5 w-full flex items-end primary-item">
            <button
              class="uppercase max-w-22 text-xs font-semibold px-2 py-1 rounded-lg border"
              [class.border-[#7CB580]]="item?.contract_status?.toUpperCase() !== 'ONGOING'"
              [class.text-[#235B2D]]="item?.contract_status?.toUpperCase() !== 'ONGOING'"
              [class.border-[#7C9CB9]]="item?.contract_status?.toUpperCase() === 'ONGOING'"
              [class.text-[#153C71]]="item?.contract_status?.toUpperCase() === 'ONGOING'">
              {{ item?.contract_status }}
            </button>
          </div>
        </ng-template>

        <ng-template let-selected pTemplate="selectedItem">
          <div class="flex items-center block whitespace-normal break-words gap-2">
            @if (selected?.select_label?.includes(' - ')) {
              <span>
                <b>{{ selected.select_label.split(' - ')[0] }}</b> - {{ selected.select_label.split(' - ')[1] }}
              </span>
            } @else {
              <span>{{ selected.select_label }}</span>
            }
          </div>
        </ng-template>
      </p-select>

      @if (isInvalid()) {
        <div class="flex items-center gap-1 mt-1 text-[#E69F00] text-sm">
          <i class="material-symbols-rounded !text-base">warning</i>
          <span>This field is required</span>
        </div>
      }
    </div>

    <div class="file-upload-container pt-2 xl:px-44 px-12">
      @if (!selectedFile) {
        <div
          class="upload-area"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)"
          [class.dragging]="isDragging"
          (keydown.enter)="fileInput.click()"
          (click)="fileInput.click()">
          <input #fileInput type="file" [accept]="acceptedFormats.join(',')" (change)="onFileSelected($event)" style="display: none" />
          <i class="material-symbols-rounded upload-icon">add_circle</i>
          <p class="upload-text">Drag and drop your file here or click to upload.</p>
          <p class="file-formats">Accepted file formats: {{ acceptedFormats.join(', ') }}</p>
        </div>
      } @else {
        <div class="upload-area" style="cursor: default">
          <i class="pi pi-file upload-icon" style="font-size: 50px; margin-bottom: 15px"></i>
          <div class="upload-area-content">
            <i
              class="pi pi-file pi-times-circle"
              style="font-size: 16px; cursor: pointer; color: #cf0808"
              (keydown.enter)="selectedFile = null"
              (click)="selectedFile = null"></i>
            <p class="upload-text" style="font-weight: 500; margin: 0">{{ selectedFile.name }}</p>
          </div>
        </div>
      }
      <p class="file-size-limit">Each file can be up to {{ maxSizeMB }} MB. Ensure uploads comply with this limit.</p>
    </div>
    <div class="xl:px-44 pb-10 px-12">
      <button
        type="button"
        class="analyze_button"
        [disabled]="!selectedFile"
        [ngClass]="{ disabled: !selectedFile || isInvalid() }"
        (click)="handleAnalyzingDocument()">
        Analyze
        <i class="pi pi-sparkles" style="font-size: 16px"></i>
      </button>
    </div>
  }
  @if (analyzingDocument() && !documentAnalyzed()) {
    <div class="loading-container">
      <div class="flex flex-col items-center justify-center pb-3 -mt-20 bg-white">
        <span class="block uppercase text-[18px] font-[700] p-6 text-[#173F6F]"> Processing Status</span>

        <img src="gifs/robot.gif" alt="Robot animado" class="w-1/4 h-auto" />

        @if (steps()[activeIndex()]) {
          @if (steps()[activeIndex()]) {
            <div class="w-full max-w-md flex items-start space-x-4">
              <div class="w-8 h-8 rounded-full bg-[#1689ca82] flex items-center justify-center text-white mt-1">
                <i class="pi pi-spinner animate-spin !text-[12px]"></i>
              </div>

              <div class="flex-1 space-y-2">
                <span class="block text-[16px] font-[500] text-[#173F6F]">
                  {{ steps()[activeIndex()].label }}
                </span>

                <div class="w-full h-2 bg-[#E8EBED] rounded">
                  <div class="h-full bg-[#00B6FF] rounded transition-all duration-300" [style.width.%]="steps()[activeIndex()].progress"></div>
                </div>
              </div>
            </div>
          }
        }
      </div>
    </div>
  }
  @if (documentAnalyzed()) {
    <section class="analyze-result-container">
      <div class="analyze-result-header">
        <h1 class="analyze-result-title">
          THE AI IDENTIFIED
          <span class="analyze-result-title-number">{{ createResultManagementService.items().length }}</span>
          RESULTS
        </h1>

        <p class="analyze-result-description">Select the ones you want to create.</p>
      </div>

      <div style="width: 100%">
        <div class="analyze-result-content">
          @if (createResultManagementService.items().length === 0) {
            <div class="no-results-container">
              <h1 class="no-results-title">ALL RESULTS DISCARDED</h1>
              <p class="no-results">Youâ€™ve discarded all the generated results. What would you like to do next?</p>

              <div class="no-results-actions">
                <p-button label="Return to Create Result" [outlined]="true" (onClick)="goBackToCreateResult()"></p-button>
                <p-button label="Upload a new file" (onClick)="goBackToUploadNewFile()"></p-button>
              </div>
            </div>
          } @else {
            @for (item of createResultManagementService.items() | slice: first() : first() + rows(); track $index) {
              <app-result-ai-item [item]="item" style="width: 100%"></app-result-ai-item>
            }
          }
        </div>

        @if (createResultManagementService.items().length > 0) {
          <div style="display: flex; justify-content: flex-end; align-items: center; background-color: #fff">
            <p-paginator
              (onPageChange)="onPageChange($event)"
              [first]="first()"
              [rows]="rows()"
              [totalRecords]="createResultManagementService.items().length"
              [showCurrentPageReport]="true"
              [showJumpToPageDropdown]="false"
              currentPageReportTemplate="Showing {first} to {last} of {totalRecords}" />
          </div>
        }
      </div>
    </section>
  }
</section>
